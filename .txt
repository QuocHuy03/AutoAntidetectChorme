    def execute_block(block, local_vars):
        nonlocal variables, loop_flags
        action = block.get('action')
        xpath = render(block.get('xpath', ''), local_vars)
        value = render(block.get('value', ''), local_vars)
        try:
                if action == 'open_url':
                    driver.get(value)
                    logger(f"[{profile['name']}] â†’ OPEN URL - {value}")

                elif action == 'switch_tab_by_index':
                        tab_index = int(value)
                        tabs = driver.window_handles
                        if 0 <= tab_index < len(tabs):
                            driver.switch_to.window(tabs[tab_index])
                            logger(f"[{profile['name']}] ðŸ”„ Chuyá»ƒn sang tab {tab_index + 1}")
                        else:
                            logger(f"[{profile['name']}] âŒ Tab chá»‰ sá»‘ {tab_index} khÃ´ng há»£p lá»‡")

                elif action == 'switch_tab_next':
                        tabs = driver.window_handles
                        current_tab = driver.current_window_handle
                        current_index = tabs.index(current_tab)
                        next_index = (current_index + 1) % len(tabs)
                        driver.switch_to.window(tabs[next_index])
                        logger(f"[{profile['name']}] ðŸ”„ Chuyá»ƒn sang tab tiáº¿p theo")

                elif action == 'switch_tab_prev':
                        tabs = driver.window_handles
                        current_tab = driver.current_window_handle
                        current_index = tabs.index(current_tab)
                        prev_index = (current_index - 1) % len(tabs)  # LÃ¹i láº¡i má»™t tab
                        driver.switch_to.window(tabs[prev_index])
                        logger(f"[{profile['name']}] ðŸ”„ Chuyá»ƒn sang tab trÆ°á»›c Ä‘Ã³")

                elif action == 'navigate_back':
                    driver.back()
                    logger(f"[{profile['name']}] â¬…ï¸ Quay láº¡i trang trÆ°á»›c")
                
                elif action == 'navigate_forward':
                    driver.forward()
                    logger(f"[{profile['name']}] âž¡ï¸ Tiáº¿n tá»›i trang tiáº¿p theo")
                
                elif action == 'refresh_page':
                    driver.refresh()
                    logger(f"[{profile['name']}] ðŸ”„ Táº£i láº¡i trang")

                elif action == 'active_tab':
                    driver.switch_to.window(driver.current_window_handle)
                    logger(f"[{profile['name']}] ðŸ”„ KÃ­ch hoáº¡t tab hiá»‡n táº¡i")

                elif action == 'loop':
                    count = int(block.get('count', 1))
                    start = int(block.get('start', 0))
                    var_name = block.get('variable', 'i')
                    loop_blocks = block.get('do', [])
                    for i in range(start, start + count):
                        variables[var_name] = i  # Cáº­p nháº­t biáº¿n toÃ n cá»¥c
                        loop_vars = variables.copy()  # Thay vÃ¬ local_vars.copy()
                        loop_flags.append({'break': False, 'continue': False})
                        for lb in loop_blocks:
                            if loop_flags[-1]['break']:
                                break
                            if loop_flags[-1]['continue']:
                                loop_flags[-1]['continue'] = False
                                break
                            execute_block(lb, loop_vars)
                        loop_flags.pop()

                elif action == 'while':
                    condition = block.get('condition')
                    var_name = block.get('variable', 'i')
                    loop_blocks = block.get('do', [])
                    while eval(condition, {}, variables):
                        loop_vars = local_vars.copy()
                        loop_vars.update(variables)
                        loop_flags.append({'break': False, 'continue': False})
                        for lb in loop_blocks:
                            if loop_flags[-1]['break']:
                                break
                            if loop_flags[-1]['continue']:
                                loop_flags[-1]['continue'] = False
                                break
                            execute_block(lb, loop_vars)
                        loop_flags.pop()

                elif action == 'break_loop':
                    if loop_flags:
                        loop_flags[-1]['break'] = True

                elif action == 'next_loop':
                    if loop_flags:
                        loop_flags[-1]['continue'] = True

                elif action == 'set_variable':
                    variables[block['name']] = block['value']

                elif action == 'increase_variable':
                    name = block['name']
                    by = int(block.get('by', 1))
                    variables[name] = variables.get(name, 0) + by

                elif action == 'decrease_variable':
                    name = block['name']
                    by = int(block.get('by', 1))
                    variables[name] = variables.get(name, 0) - by

                elif action == 'input_text':
                    elem = WebDriverWait(driver, 10).until(EC.presence_of_element_located((By.XPATH, xpath)))
                    elem.clear()
                    elem.send_keys(value)
                    logger(f"[{profile['name']}] â†’ NHáº¬P => {xpath} | VALUE = {value}")

                elif action == 'click':
                    WebDriverWait(driver, 10).until(EC.element_to_be_clickable((By.XPATH, xpath))).click()
                    logger(f"[{profile['name']}] â†’ CLICK => {xpath}")

                elif action == 'click_coords':
                    x, y = map(int, value.strip().split(','))
                    webdriver.ActionChains(driver).move_by_offset(x, y).click().perform()
                    logger(f"[{profile['name']}] ðŸ–±ï¸ CLICK theo tá»a Ä‘á»™: ({x}, {y})")
                    webdriver.ActionChains(driver).move_by_offset(-x, -y).perform()

                elif action == 'input_press_key':
                    elem = WebDriverWait(driver, 10).until(EC.presence_of_element_located((By.XPATH, xpath)))
                    key = getattr(Keys, value.upper(), None)
                    if key:
                        elem.click()
                        elem.send_keys(key)
                        logger(f"[{profile['name']}] â†’ PRESS KEY {value.upper()} táº¡i {xpath}")
                    else:
                        logger(f"[{profile['name']}] âŒ PhÃ­m khÃ´ng há»£p lá»‡: {value}")

                elif action == 'element_exists':
                    elements = driver.find_elements(By.XPATH, xpath)
                    exists = len(elements) > 0
                    logger(f"[{profile['name']}] â†’ ELEMENT {'Tá»’N Táº I' if exists else 'KHÃ”NG Tá»’N Táº I'} => {xpath}")
                    
                    # Náº¿u pháº§n tá»­ tá»“n táº¡i, thá»±c hiá»‡n cÃ¡c hÃ nh Ä‘á»™ng trong if_true
                    if exists and 'if_true' in block:
                        for inner in block['if_true']:
                            execute_block(inner, local_vars)
                    
                    # Náº¿u pháº§n tá»­ khÃ´ng tá»“n táº¡i, thá»±c hiá»‡n cÃ¡c hÃ nh Ä‘á»™ng trong if_false
                    elif not exists and 'if_false' in block:
                        for inner in block['if_false']:
                            execute_block(inner, local_vars)
                    
                    # Náº¿u pháº§n tá»­ khÃ´ng tá»“n táº¡i vÃ  stop_on_fail = true, dá»«ng script
                    if not exists and block.get("stop_on_fail", False):
                        logger(f"[{profile['name']}] ðŸ›‘ Dá»ªNG SCRIPT do element khÃ´ng tá»“n táº¡i vÃ  'stop_on_fail: true'")
                        
                        # Gá»i API Ä‘á»ƒ Ä‘Ã³ng profile
                        close_profile(provider, base_url, profile['id'])  # ÄÃ³ng profile thÃ´ng qua API
                        
                        # Äáº£m báº£o Ä‘Ã³ng trÃ¬nh duyá»‡t vÃ  thoÃ¡t khá»i script
                        try:
                            driver.quit()  # ÄÃ³ng trÃ¬nh duyá»‡t
                        except Exception as e:
                            logger(f"âŒ Lá»—i khi Ä‘Ã³ng trÃ¬nh duyá»‡t: {e}")
                        
                        exit()  # Dá»«ng script hoÃ n toÃ n
                
                elif action == 'upload_file':
                    file_input = WebDriverWait(driver, 10).until(EC.presence_of_element_located((By.XPATH, xpath)))
                    file_input.send_keys(value)
                    logger(f"[{profile['name']}] ðŸ“¤ ÄÃ£ táº£i lÃªn file: {value}")

                elif action == 'wait':
                    time.sleep(float(value))
                    logger(f"[{profile['name']}] ðŸ•’ WAIT {value} giÃ¢y")

                elif action == 'switch_iframe':
                    iframe_elem = WebDriverWait(driver, 10).until(EC.presence_of_element_located((By.XPATH, xpath)))
                    driver.switch_to.frame(iframe_elem)
                    logger(f"[{profile['name']}] ðŸ”„ Chuyá»ƒn vÃ o iframe vá»›i xpath: {xpath}")

                elif action == 'switch_to_default_content':
                    driver.switch_to.default_content()
                    logger(f"[{profile['name']}] ðŸ”„ Quay láº¡i ná»™i dung chÃ­nh cá»§a trang")
                
                elif action == 'switch_popup_window':
                    popup_window = driver.window_handles[-1]  # Chá»n cá»­a sá»• popup cuá»‘i cÃ¹ng trong danh sÃ¡ch
                    driver.switch_to.window(popup_window)
                    logger(f"[{profile['name']}] ðŸ”„ Chuyá»ƒn sang cá»­a sá»• popup")

                elif action == 'close_popup_window':
                    driver.close()  # ÄÃ³ng cá»­a sá»• popup hiá»‡n táº¡i
                    driver.switch_to.window(driver.window_handles[0])  # Quay láº¡i cá»­a sá»• chÃ­nh
                    logger(f"[{profile['name']}] ðŸ”’ ÄÃ£ Ä‘Ã³ng cá»­a sá»• popup")
                    
                elif action == 'scroll':
                    if value == "down":
                        driver.execute_script("window.scrollBy(0, 300);")
                        logger(f"[{profile['name']}] â†“ Scroll xuá»‘ng 300px")
                    elif value == "up":
                        driver.execute_script("window.scrollBy(0, -300);")
                        logger(f"[{profile['name']}] â†‘ Scroll lÃªn 300px")
                    elif value == "to_bottom":
                        driver.execute_script("window.scrollTo(0, document.body.scrollHeight);")
                        logger(f"[{profile['name']}] â†“ Scroll xuá»‘ng cuá»‘i trang")
                    elif value == "to_top":
                        driver.execute_script("window.scrollTo(0, 0);")
                        logger(f"[{profile['name']}] â†‘ Scroll lÃªn Ä‘áº§u trang")
                    elif value == "element":
                        if xpath:
                            elem = WebDriverWait(driver, 10).until(EC.presence_of_element_located((By.XPATH, xpath)))
                            driver.execute_script("arguments[0].scrollIntoView({behavior: 'smooth', block: 'center'});", elem)
                            logger(f"[{profile['name']}] ðŸ” Scroll tá»›i element: {xpath}")
                    elif value == "random":
                        direction = random.choice([-1, 1])
                        pixels = random.randint(100, 600)
                        driver.execute_script(f"window.scrollBy(0, {direction * pixels});")
                        logger(f"[{profile['name']}] ðŸŽ² Scroll ngáº«u nhiÃªn {('â†“' if direction == 1 else 'â†‘')} {pixels}px")
                    else:
                        pixels = int(value)
                        driver.execute_script(f"window.scrollBy(0, {pixels});")
                        logger(f"[{profile['name']}] â†• Scroll theo pixel: {pixels}")

                elif action == 'screenshot':
                    os.makedirs('screenshots', exist_ok=True)
                    path = f'screenshots/{profile['name']}_{int(time.time())}.png'
                    driver.save_screenshot(path)
                    logger(f"[{profile['name']}] ðŸ“¸ Screenshot lÆ°u táº¡i: {path}")
                
                elif action == 'eval_script':
                    try:
                        result = driver.execute_script(value)
                        if 'store_as' in block:
                            var_name = block['store_as']
                            variables[var_name] = result
                            logger(f"[{profile['name']}] ðŸ§  JS Eval â†’ LÆ°u '{var_name}' = {result}")
                        else:
                            logger(f"[{profile['name']}] ðŸ§  JS Eval â†’ {result}")
                    except Exception as e:
                        logger(f"[{profile['name']}] âŒ eval_script lá»—i: {e}")

                elif action == 'stop_script':
                    logger(f"[{profile['name']}] ðŸ›‘ SCRIPT Dá»ªNG Láº I: {value or block.get('reason', 'KhÃ´ng cÃ³ lÃ½ do cá»¥ thá»ƒ')}")
                    close_profile(provider, base_url, profile['id'])
                    driver.quit()
                    exit()

                time.sleep(1)

        except Exception as e:
                logger(f"[{profile['name']}] â†’ âŒ {action} {xpath} => {e}")
